---
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  flexdashboard::flex_dashboard:
    social: [ "menu" ]
    logo: !expr system.file("app/www", "logo.png", package = "monkeyr")
    favicon: !expr system.file("app/www", "favicon.png", package = "monkeyr")
    # logo: "../www/logo.png"
    # favicon: "../www/favicon.png"
    orientation: rows
    pandoc_args: [
      "+RTS", "-K16m",
      "-RTS"
    ]

# paths with `inst` will only work in `dev` setting. 
# in `production` setting, please use real data
# or call installed files with `system.file`
# see example in `?knit_report()`
params:
  filtered_obs:             "../dummy-data/conn_29June/obs.csv"
  filtered_weather:         "../dummy-data/conn_29June/weather.csv"
  filtered_devices:         "../dummy-data/conn_29June/dev.csv"
  filtered_interventions:   "../dummy-data/conn_29June/interv.csv"
  report_params:            "-map-"                                            
  fromTimeStamp:            1687939839
  toTimeStamp:              1688026239
---

```{r}
ENABLE_DEBUG <- FALSE
```


```{r setup }
  ## load monkeyr package
  library(monkeyr)
  library(dplyr)
  library(magrittr)
  library(fontawesome)
  # use fontawesome::fa_metadata() to see avail icons!


  LATEST_FW <- "V1.5.9"
  NC_FW     <- "V0.0.0"

## other dependencies loaded through namespace
```

```{r wrangle_data}

  ## STANDARD DATA WRANGLING & JOINING
  ## ---------------------------------
  
  tryCatch(
    {
      ## Get from files
      wrangled_devices <- monkeyr::wrangle_devices(params$filtered_devices) %>%
        dplyr::select(c(school_name = school, device_id, country, classRoom, long, lat, fw_ver, status, name, last_comm)) %>%
      ## Flag missing info
        dplyr::mutate(fw_ver           = tidyr::replace_na(fw_ver,      "V0.0.0")) %>%
        dplyr::mutate(status           = tidyr::replace_na(status,      "NC")) %>%
        dplyr::mutate(school_name      = tidyr::replace_na(school_name, "missing")) %>%
        dplyr::mutate(classRoom        = tidyr::replace_na(classRoom,   "missing")) %>%
      ## Separate school & class info from name
        dplyr::mutate(school_code = stringr::str_split_i(name, "/", 1))  %>%
        dplyr::mutate(class_code  = stringr::str_split_i(name, "/", -1)) %>%
      ## Flag test devices
        dplyr::mutate(test = FALSE) %>%
        dplyr::mutate(test = if_else(school_code > 9999, TRUE, test)) %>%
        dplyr::mutate(test = if_else(startsWith(school_code, "10000"), TRUE, test)) %>%
        dplyr::mutate(school_name = if_else(school_code > 9999, "test", school_name)) %>%
        dplyr::mutate(school_name = if_else(startsWith(school_code, "10000"), "test", school_name))
      
      wrangled_obs <- readr::read_csv(params$filtered_obs, col_types = "ciiicd") %>%
        group_by(ts, device_id, seq) %>%
        summarise()      
      
      
      #
      #   Status Registers - uint32t (32 bit registers)
      #
      #   define STAT_REG_HT   4   // SCD30   : 0 / HCHO     : 1 / SHT30 : 2
      #   define STAT_REG_LUX  5   // OPT3001 : 0 / TSL75721 : 1
      #   define STAT_REG_DBA  6   // ICS43434: 0
      #
      #   define STAT_REG_SYS  9   // 
      
      
      ## Join
      wrangled_devices_1 <-
        wrangled_devices %>%

        ## Join obs data
        dplyr::full_join(
          dplyr::select(
            wrangled_obs
          ),
          by = "device_id"
        )
      
      
      ## How many records should there be?
      interval <- 15 * 60
      timespan <- params$toTimeStamp - params$fromTimeStamp
      fullvol  <- (timespan / interval) + 1
      
      ## Get min & max ts
      maxTs   <- max(wrangled_obs$ts)
      minTs   <- min(wrangled_obs$ts)
      fullvol <- (maxTs - minTs) / interval + 1 

      
      ## Summarise by device
      wrangled_devices_2 <-
        wrangled_devices_1 %>%
        dplyr::group_by(across(c(-ts))) %>%
        dplyr::summarise(
          last_conn = max(ts),
          data_vol = n() / fullvol
          ) %>%
        dplyr::ungroup() %>%
        dplyr::mutate(
          last_conn = tidyr::replace_na(last_conn, 0)
        ) %>%
        dplyr::mutate(conn = (maxTs - last_conn) < (3600*24*13)) %>%
        dplyr::select(-c(device_id, last_conn, country))
      
      
      ## Conn by FW
      chart_conn <- wrangled_devices_2 %>%
        group_by(conn, fw_ver) %>%
        summarise(count = n()) %>%
        ggplot2::ggplot(ggplot2::aes(fill=conn, x=fw_ver, y=count)) + 
        ggplot2::geom_bar(position="stack", stat="identity") + 
        ggplot2::scale_fill_brewer(palette = "Blues")
      
        
      ## DataVol by FW
      chart_data_vol <- wrangled_devices_2 %>%
        mutate(data_vol = case_when(
          data_vol > 0.98 ~ "100%",
          data_vol > 0.90 ~ ">90%",
          data_vol > 0.80 ~ ">80%",
          data_vol > 0.50 ~ ">50%",
          data_vol < 0.50 ~ "<50%",
        )) %>%
        group_by(data_vol, fw_ver) %>%
        summarise(count = n()) %>%

        
        
        ggplot2::ggplot(ggplot2::aes(fill=data_vol, x=fw_ver, y=count)) + 
        ggplot2::geom_bar(position="stack", stat="identity") + 
        ggplot2::scale_fill_brewer(palette = "Blues")
      
        
      ## Summarise by School
      wrangled_devices_3 <-
        wrangled_devices_2 %>%
        dplyr::mutate(nc_fw = (last_comm == 0)) %>%
        dplyr::mutate(old_fw = (fw_ver < LATEST_FW & (!nc_fw))) %>%
        dplyr::mutate(latest_fw = (fw_ver == LATEST_FW)) %>%
        dplyr::mutate(off_on = case_when(
          old_fw  ~ paste0(" -", classRoom, "- "),
          !old_fw ~ ""
        )) %>%
        dplyr::mutate(nc = case_when(
          nc_fw  ~ paste0(" -", classRoom, "- "),
          !nc_fw ~ ""
        )) %>%
        dplyr::group_by(across(c(school_name))) %>%
        dplyr::summarise(
          installed = n(),
          latest_fw = sum(latest_fw),
          old_fw = sum(old_fw),
          nc_fw = sum(nc_fw),
          off_on = paste0(off_on, collapse = ""),
          nc = paste0(nc, collapse = "")
          ) %>%
        dplyr::ungroup() %>%
        dplyr::arrange(desc(old_fw))
      
      
      kable_summary <-
        wrangled_devices_3 %>%
        kableExtra::kbl(col.names = c("School", "Total", "OK", "Needs Off/on", "Failed Install", "List-Off/On", "List-NC"),
                        format = "html",
                        align = "lcccr") %>%
        kableExtra::kable_material(lightable_options = c("striped", "hover", "condensed"),
                       html_font = "sans-serif") %>%
        kableExtra::column_spec(1:5, width = c("25em","17em","17em","17em","35em"))

    ## Scroll if long
      if (nrow(wrangled_devices_3) > 14) {
        kable_summary <- kable_summary %>%
          kableExtra::scroll_box(height = "800px")
      }

    },
    error = function(cond) {
      monkeyr::monkey_knit_error(err = cond, resource = "wrangle_data")
    }
  )
```

---
title: "Te Haratau Connectivity Report"
---

```{r check_data, results='asis'}
  ## Bail if nothing in data. Returns empty report.
  if ((nrow(wrangled_devices) == 0) | (nrow(wrangled_obs) == 0)) {
    cat("No data present for the requested devices and timespan. Aborting report.")
    knitr::knit_exit("</body></html>")
  }
```






<!-- PAGE 1: Summary Grouped  -->
<!-- ------------------------ -->

# Connectivity Summary {data-icon="fa-wifi"}

## Column 1

### Connectivity Summary by School {data-width=600}

```{r}
  kable_summary
```

### Connectivity & Data Volume by Firmware Version {data-width=400}

#### Connectivity By Firmware Version

```{r out.width='80%', fig.align="center", fig.height=3}
chart_conn
```

#### Data Volume by Firmware Version

```{r out.width='80%', fig.align="center", fig.height=3}
chart_data_vol
```


# Database Corruption & Test/Install Artifacts {data-icon="fa-thumbs-o-down"}

## Column 1

### Duplicate Installs {data-width=600}

```{r}

## Get Duplicate devices
  devices_dup <- wrangled_devices %>%
    dplyr::mutate(name = stringr::str_squish(tolower(name))) %>% ## make all white spce into spaces.
    dplyr::mutate(name = stringr::str_replace_all(name, "[ .,-]", "")) %>% ## remove spaces & punctuation
    dplyr::group_by(name) %>%
    dplyr::filter(n()>1) %>%
    dplyr::ungroup() %>%
    dplyr::arrange(desc(name)) %>%
    dplyr::select(c(device_id, school_code, class_code, last_comm)) %>%
    dplyr::group_by(school_code, class_code) %>%
    dplyr::mutate(duplicate = ifelse(last_comm == max(last_comm), FALSE, TRUE)) %>%
    dplyr::ungroup()

## Kable of Duplicated devices
  if (nrow(devices_dup) > 0) {
    kable_devices_dup <-
      devices_dup %>%
      # arrange(`school_code`, `class_code`, `last_comm`) %>%
      kableExtra::kbl(col.names = c("Device Id", "School Code", "Class Code", "Last Comm", "Duplicate"),
                      format = "html",
                      align = "lllll") %>%
      kableExtra::kable_material(
                      lightable_options = c("striped", "hover", "condensed"),
                      html_font = "sans-serif") %>%
      kableExtra::column_spec(1:5, width = c("20em","20em","20em","20em","20em"))

## Scroll if long
    if (nrow(devices_dup) > 14) {
      kable_devices_dup <- kable_devices_dup %>%
        kableExtra::scroll_box(height = "800px")
    }
  } else {
    kable_devices_dup <- "No Duplicate Devices detected!"
  }

## Print Table
  kable_devices_dup

  
## Set Duplicates to Unclaimed
## Will Do this inside AWS Lambda - this is a horrible place to write this code!
  
```

### Demo/Test Devices {data-width=400}

```{r out.width='80%', fig.align="center", fig.height=3}

## Get Test devices
  devices_test <- wrangled_devices %>%
    dplyr::filter(test == TRUE) %>%
    dplyr::select(c(device_id, school_code, class_code))
    
## Kable of Test devices
  if (nrow(devices_test) > 0) {
    kable_devices_test <-
      devices_test %>%
      kableExtra::kbl(col.names = c("Device Id", "School Code", "Class Code"),
                      format = "html",
                      align = "lll") %>%
      kableExtra::kable_material(lightable_options = c("striped", "hover", "condensed"),
                     html_font = "sans-serif") %>%
      kableExtra::column_spec(1:3, width = c("20em","30em","30em"))
        
  ## Scroll if long
    if (nrow(devices_test) > 14) {
      kable_devices_test <- kable_devices_test %>%
        kableExtra::scroll_box(height = "800px")
    }
  } else {
    kable_devices_test <- "No Test Devices detected!"
  }
    
## Print Table
  kable_devices_test
  
```


# N4L Not Updated {data-icon="fa-refresh"}

## Column 1

### Missing School Info {data-width=600}

```{r}
      
## Pull School Codes from Excel File
  school_codes <-
  data.table::fread(
    "../schoolCodes/2023-School-Name-And-Number-Codes.csv",
    na.strings = c("",NA),
    skip = 3,
    colClasses = list(
      character = c("Name of School", "Notes Or Old Name"),
      boolean   = c("Closed"),
      integer   = c("Number"))
    ) %>%
    dplyr::mutate(Closed = case_when (
      is.na(Closed) ~ FALSE,
      Closed == "*" ~ TRUE,
      TRUE ~ FALSE
    )) %>%
    dplyr::rename(school_code = Number)
  
  
## Get devices missing Schools
  devices_missing_school <- wrangled_devices %>%
    dplyr::filter(school_name == "missing") %>%
    dplyr::filter(test == FALSE) %>%
    dplyr::mutate(school_code = as.integer(school_code)) %>%
    dplyr::select(c(device_id, school_code, class_code)) %>%
  ## Join Suspected School from School Codes
    dplyr::left_join(
      dplyr::select( # remove addr & email addr!
        school_codes,
        school_code,
        "Name of School"
      ),
      by = "school_code"
    ) %>%
    dplyr::rename(matched_school = "Name of School")
  
  
## Get devices Missing Classrooms
  if (nrow(devices_missing_school) > 0) {
    kable_missing_class <-
      devices_missing_school %>%
      kableExtra::kbl(col.names = c("Device Id", "School Code", "Class Code", "Matching School"),
                      format = "html",
                      align = "llll") %>%
      kableExtra::kable_material(lightable_options = c("striped", "hover", "condensed"),
                     html_font = "sans-serif") %>%
      kableExtra::column_spec(1:4, width = c("20em","20em","20em","20em"))
  
## Scroll if long
    if (nrow(devices_missing_school) > 14) {
      kable_missing_class <- kable_missing_class %>%
        kableExtra::scroll_box(height = "800px")
    }
  } else {
    kable_missing_class <- "No Devices detected missing school & Class fields"
  }
  

## Print Table  
  kable_missing_class  
  
  
## Actually Update with Missing Schools
## Will Do this inside AWS Lambda - this is a horrible place to write this code!
  
```

### Devices / Schools Expiring Soonest {data-width=400}

```{r out.width='80%', fig.align="center", fig.height=3}

## Get Expiry for each device



```
